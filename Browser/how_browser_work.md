# 浏览器工作原理
## 简介
[参考原文](https://www.html5rocks.com/zh/tutorials/internals/howbrowserswork/)
### 浏览器的主要功能
浏览器的主要功能就是向服务器发出请求，在浏览器窗口中展示您选择的网络资源。

### 浏览器的高层结构
1. 用户界面 
2. 浏览器引擎
3. 呈现引擎
4. 网络
5. 用户界面后端
6. JavaScript 解释器
7. 数据存储

![浏览器主要组建](../Assets/how_browser_work/browser_main_component.png)

Chrome 浏览器的每个标签页都分别对应一个呈现引擎实例。每个标签页都是一个独立的进程。


## 呈现引擎
渲染引擎
浏览器（Firefox、Chrome 浏览器和 Safari）是基于两种呈现引擎构建的。Firefox 使用的是 Gecko，这是 Mozilla 公司“自制”的呈现引擎。而 Safari 和 Chrome 浏览器使用的都是 WebKit。

### 主流程

![呈现引擎的基本流程](../Assets/how_browser_work/render_engine_basic_flow.png)

解析html语句转化成DOM树，样式转化成渲染树 -> 布局 -> 绘制，是一个渐进的过程，逐步渲染页面
![webkit主流程](../Assets/how_browser_work/webkit_flow.png)
![gecko主流程](../Assets/how_browser_work/gecko.jpg)

## 解析和DOM树构建
### 解析
解析 2 + 3 - 1 这个表达式，会返回下面的树：
![数学表达式树节点](../Assets/how_browser_work/math_express_tree_node.png)

### 语法
解析是以文档所遵循的语法规则（编写文档所用的语言或格式）为基础的。所有可以解析的格式都必须对应确定的**语法**（由词汇和语法规则构成）。这称为与上下文无关的语法。人类语言并不属于这样的语言，因此无法用常规的解析技术进行解析。

### 解析器和词法分析器的组合
解析过程分为两步：词法分析和语法分析。
词法分析是将输入内容分割成大量标记的过程。
语法分析是应用语言的语法规则的过程。

**词法分析器**（有时也称为标记生成器），负责将输入内容分解成一个个有效标记；而**解析器**负责根据语言的语法规则分析文档的结构，从而构建解析树。
![从源文档到解析树](../Assets/how_browser_work/analysis_parse_tree.png)
解析是一个迭代的过程

### 翻译
![编译过程](../Assets/how_browser_work/parsing_progress.png)

### DOM
解析器的输出“解析树”是由 DOM 元素和属性节点构成的树结构。
DOM 是文档对象模型 (Document Object Model) 的缩写。
它是 HTML 文档的对象表示，同时也是外部内容（例如 JavaScript）与 HTML 元素之间的接口。
解析树的根节点是“Document”对象。
![DOM树](../Assets/how_browser_work/DOM_tree.png)

### 解析算法
![HTML解析流程](../Assets/how_browser_work/HTML_parsing.png)
### 标记化算法
```html
<html>
  <body>
    Hello world
  </body>
</html>
```
初始状态是数据状态。遇到字符 < 时，状态更改为“标记打开状态”。接收一个 a-z 字符会创建“起始标记”，状态更改为“标记名称状态”。这个状态会一直保持到接收 > 字符。在此期间接收的每个字符都会附加到新的标记名称上。在本例中，我们创建的标记是 html 标记。

遇到 > 标记时，会发送当前的标记，状态改回“数据状态”。<body> 标记也会进行同样的处理。目前 html 和 body 标记均已发出。现在我们回到“数据状态”。接收到 Hello world 中的 H 字符时，将创建并发送字符标记，直到接收 </body> 中的 <。我们将为 Hello world 中的每个字符都发送一个字符标记。

现在我们回到“标记打开状态”。接收下一个输入字符 / 时，会创建 end tag token 并改为“标记名称状态”。我们会再次保持这个状态，直到接收 >。然后将发送新的标记，并回到“数据状态”。</html> 输入也会进行同样的处理。
![对示例输入进行标记化](../Assets/how_browser_work/input_label.png)
### 树构建算法
![HTML构建树](../Assets/how_browser_work/HTML_tree_build.png)
### 解析结束后的操作
浏览器会将文档标注为交互状态，并开始解析那些处于“deferred”模式的脚本
### 浏览器的容错机制
您在浏览 HTML 网页时从来不会看到“语法无效”的错误。这是因为浏览器会纠正任何无效内容，然后继续工作。

### CSS 解析
这表示一个规则集就是一个选择器，或者由逗号和空格（S 表示空格）分隔的多个（数量可选）选择器。规则集包含了大括号，以及其中的一个或多个（数量可选）由分号分隔的声明。
### WebKit CSS 解析器
![解析CSS](../Assets/how_browser_work/parsing_CSS.png)
### 处理脚本和样式表的顺序
#### 脚本
网络的模型是同步的。网页作者希望解析器遇到 <script> 标记时立即解析并执行脚本。文档的解析将停止，直到脚本执行完毕。如果脚本是外部的，那么解析过程会停止，直到从网络同步抓取资源完成后再继续。此模型已经使用了多年，也在 HTML4 和 HTML5 规范中进行了指定。作者也可以将脚本标注为“defer”，这样它就不会停止文档解析，而是等到解析结束才执行。HTML5 增加了一个选项，可将脚本标记为异步，以便由其他线程解析和执行。
#### 预解析
WebKit 和 Firefox 都进行了这项优化。在执行脚本时，其他线程会解析文档的其余部分，找出并加载需要通过网络加载的其他资源。通过这种方式，资源可以在并行连接上加载，从而提高总体速度。请注意，预解析器不会修改 DOM 树，而是将这项工作交由主解析器处理；预解析器只会解析外部资源（例如外部脚本、样式表和图片）的引用。

#### 样式表
Firefox 在样式表加载和解析的过程中，会禁止所有脚本。而对于 WebKit 而言，仅当脚本尝试访问的样式属性可能受尚未加载的样式表影响时，它才会禁止该脚本。

## 呈现树构建
### 呈现树和 DOM 树的关系
## 布局

## 绘制

## 动态变化

## 呈现引擎的线程

## CSS2 可视化模型

## 资源